# Nombre del workflow que aparecerá en GitHub Actions
name: Build, Test & Security Scans (SAST/SCA/IMAGESCAN/DAST)

# Evento que dispara el workflow
on:
  push:
    branches: ["**"]

# Permisos mínimos del token de GitHub Actions
permissions:
  contents: read

jobs:
  # ============================
  # JOB 0: SECRET SCANNING (NO BLOQUEANTE, 1 SOLO ARTEFACTO)
  # ============================
  secrets_scan:
    name: Secrets Detection (detect-secrets + gitleaks + trufflehog) - non-blocking
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for better secret hunting)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: detect-secrets scan (non-blocking)
        continue-on-error: true
        run: |
          mkdir -p secret-reports
          detect-secrets scan --all-files --exclude-files '\.git/.*' > secret-reports/detect-secrets.json

      - name: Run Gitleaks (non-blocking)
        continue-on-error: true
        run: |
          docker run --rm -v "$PWD:/repo" -w /repo zricethezav/gitleaks:latest \
            detect --source /repo --report-format json --report-path secret-reports/gitleaks.json --redact --no-git

      - name: Run TruffleHog (non-blocking)
        continue-on-error: true
        run: |
          docker run --rm -v "$PWD:/repo" -w /repo trufflesecurity/trufflehog:latest \
            filesystem /repo --json > secret-reports/trufflehog.json

      - name: Build consolidated summary
        continue-on-error: true
        run: |
          cat > secret-reports/summary.py << 'EOF'
          import json
          from pathlib import Path

          p = Path("secret-reports")

          def safe_load_json(path: Path, default):
            try:
              return json.loads(path.read_text())
            except Exception:
              return default

          ds = safe_load_json(p / "detect-secrets.json", {})
          results = ds.get("results", {})
          ds_count = sum(len(v) for v in results.values()) if isinstance(results, dict) else -1

          gl = safe_load_json(p / "gitleaks.json", [])
          gl_count = len(gl) if isinstance(gl, list) else -1

          try:
            th_text = (p / "trufflehog.json").read_text()
            th_count = len([ln for ln in th_text.splitlines() if ln.strip()])
          except Exception:
            th_count = -1

          summary = {
            "detect_secrets_findings": ds_count,
            "gitleaks_findings": gl_count,
            "trufflehog_findings": th_count,
            "mode": "non-blocking",
            "files": {
              "detect_secrets_report": "secret-reports/detect-secrets.json",
              "gitleaks_report": "secret-reports/gitleaks.json",
              "trufflehog_report": "secret-reports/trufflehog.json"
            }
          }

          (p / "summary.json").write_text(json.dumps(summary, indent=2))
          print(json.dumps(summary, indent=2))
          EOF

          python secret-reports/summary.py

      - name: Package reports into single artifact file
        if: always()
        run: |
          tar -czf secrets-report.tgz -C secret-reports .
          ls -lah secrets-report.tgz

      - name: Upload single secrets artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-report
          path: secrets-report.tgz
          if-no-files-found: ignore

  # ============================
  # JOB 1: BUILD + SAST
  # ============================
  build_sast:
    name: Build + Unit Tests + SAST (SonarCloud)
    needs: secrets_scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "zulu"
          cache: maven

      - name: Build + Test
        run: mvn -B verify

      - name: SonarCloud analysis (SAST)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=dherrrera-source_javaprojectkey \
            -Dsonar.organization=dherrrera-source \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN

  # ============================
  # JOB 2: SCA (DEPENDENCIAS)
  # ============================
  sca_snyk:
    name: SCA (Snyk) - Dependency vulnerabilities
    needs: build_sast
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Snyk CLI
        run: npm i -g snyk

      - name: Run Snyk SCA (generate report)
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          snyk test --all-projects --json > snyk-report.json

      - name: Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sca-report
          path: snyk-report.json
          if-no-files-found: ignore

  # ============================
  # JOB 2.5: IMAGE SCAN (TRIVY) - SIN APT REPO (USANDO ACTION OFICIAL)
  # ============================
  image_scan_trivy:
    name: Image Scan (Trivy) - Container vulnerabilities
    needs: sca_snyk
    runs-on: ubuntu-latest

    # Para leer imágenes privadas en GHCR necesitas packages:read
    permissions:
      contents: read
      packages: read

    steps:
      - name: Prepare report folder
        run: mkdir -p trivy-reports

      # Ajusta esta imagen a una que EXISTA (si no existe, se genera trivy-error.txt y artifact igual)
      - name: Define image reference
        run: |
          echo "IMAGE_REF=ghcr.io/dherrrera-source/java-reachability-playground:latest" >> $GITHUB_ENV

      # Login a GHCR (si tu imagen es privada)
      - name: Login to GHCR (if private)
        continue-on-error: true
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
            -u ${{ github.actor }} --password-stdin

      # Trivy Action (no depende de APT repo)
      # - exit-code: "0" => no bloquea el pipeline aunque encuentre vulnerabilidades
      # - output => genera archivo para evidencia
      - name: Trivy scan image (non-blocking)
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@v0.33.1
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: "json"
          output: "trivy-reports/trivy-image.json"
          exit-code: "0"
          ignore-unfixed: true

      # Si por cualquier motivo no se generó el JSON (imagen inexistente/tag malo), deja evidencia clara
      - name: Write "scan failed / image not found" evidence
        if: always()
        run: |
          if [ ! -f trivy-reports/trivy-image.json ]; then
            echo "Trivy scan did not produce output. Possible causes:" > trivy-reports/trivy-error.txt
            echo "- IMAGE_REF does not exist (manifest unknown)" >> trivy-reports/trivy-error.txt
            echo "- Tag is wrong (e.g., latest not published)" >> trivy-reports/trivy-error.txt
            echo "- Registry auth/permissions (packages:read) missing" >> trivy-reports/trivy-error.txt
            echo "IMAGE_REF=${IMAGE_REF}" >> trivy-reports/trivy-error.txt
          fi

      - name: Package Trivy report
        if: always()
        run: |
          tar -czf trivy-image-report.tgz -C trivy-reports .
          ls -lah trivy-image-report.tgz

      - name: Upload Trivy artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.tgz
          if-no-files-found: ignore

  # ============================
  # JOB 3: DAST (APLICACIÓN)
  # ============================
  dast_zap:
    name: DAST (OWASP ZAP Baseline)
    needs: image_scan_trivy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        continue-on-error: true
        with:
          target: "http://testphp.vulnweb.com/"
          cmd_options: "-a"

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_html.html
            report_md.md
            report_json.json
          if-no-files-found: ignore