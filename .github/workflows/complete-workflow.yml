# Nombre del workflow que aparecerá en GitHub Actions
name: Build, Test & Security Scans (SAST/SCA/DAST)

# Evento que dispara el workflow
on:
  push:
    branches: ["**"]

# Permisos mínimos del token de GitHub Actions
permissions:
  contents: read

jobs:
  # ============================
  # JOB 0: SECRET SCANNING
  # ============================
  secrets_scan:
    name: Secrets Detection (pre-build)
    runs-on: ubuntu-latest

    steps:
      # Descarga el código del repositorio
      - name: Checkout
        uses: actions/checkout@v4

      # Instala detect-secrets
      - name: Install detect-secrets
        run: pip install detect-secrets

      # Escanea el repositorio en busca de secretos
      # Si se detectan secretos reales, el audit falla el job
      - name: Scan for secrets
        run: |
          detect-secrets scan --all-files > .secrets.baseline
          detect-secrets audit .secrets.baseline

      # Sube el resultado como Artifact (evidencia)
      - name: Upload secrets scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-report
          path: .secrets.baseline
          if-no-files-found: ignore

  # ============================
  # JOB 1: BUILD + SAST
  # ============================
  build_sast:
    name: Build + Unit Tests + SAST (SonarCloud)
    needs: secrets_scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "zulu"
          cache: maven

      - name: Build + Test
        run: mvn -B verify

      - name: SonarCloud analysis (SAST)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=dherrrera-source_javaprojectkey \
            -Dsonar.organization=dherrrera-source \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN

  # ============================
  # JOB 2: SCA (DEPENDENCIAS)
  # ============================
  sca_snyk:
    name: SCA (Snyk) - Dependency vulnerabilities
    needs: build_sast
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Snyk CLI
        run: npm i -g snyk

      - name: Run Snyk SCA (generate report)
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          snyk test --all-projects --json > snyk-report.json

      - name: Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sca-report
          path: snyk-report.json
          if-no-files-found: ignore

  # ============================
  # JOB 3: DAST (APLICACIÓN)
  # ============================
  dast_zap:
    name: DAST (OWASP ZAP Baseline)
    needs: sca_snyk
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        continue-on-error: true
        with:
          target: "http://testphp.vulnweb.com/"
          cmd_options: "-a"

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_html.html
            report_md.md
            report_json.json
          if-no-files-found: ignore