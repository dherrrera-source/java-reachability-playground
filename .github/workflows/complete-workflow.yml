# Nombre del workflow que aparecerá en GitHub Actions
name: Build, Test & Security Scans (SAST/SCA/DAST)

# Evento que dispara el workflow: se ejecuta en cada push a cualquier rama
on:
  push:
    branches: ["**"]

# Permisos mínimos del token de GitHub Actions (principio de mínimo privilegio)
permissions:
  contents: read

jobs:
  # ============================
  # JOB 1: BUILD + SAST
  # ============================
  build_sast:
    name: Build + Unit Tests + SAST (SonarCloud)
    runs-on: ubuntu-latest

    steps:
      # Descarga el código del repositorio en el runner
      - name: Checkout
        uses: actions/checkout@v4

      # Instala Java JDK 21 usando la distribución Zulu
      # Habilita cache de Maven para acelerar builds futuros
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "zulu"
          cache: maven

      # Compila y ejecuta pruebas unitarias (fase verify)
      - name: Build + Test
        run: mvn -B verify

      # Ejecuta análisis SAST con SonarCloud (no repite verify)
      - name: SonarCloud analysis (SAST)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Plugin oficial de Sonar para Maven (fully-qualified para evitar error "No plugin found for prefix sonar")
          # Publica el análisis en SonarCloud usando projectKey/organization y token
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=dherrrera-source_javaprojectkey \
            -Dsonar.organization=dherrrera-source \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN

  # ============================
  # JOB 2: SCA (DEPENDENCIAS)
  # ============================
  sca_snyk:
    name: SCA (Snyk) - Dependency vulnerabilities
    needs: build_sast
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Instala Snyk CLI (necesario para usar "snyk test" en el runner)
      - name: Install Snyk CLI
        run: npm i -g snyk

      # Ejecuta Snyk SCA y genera reporte JSON (modo visibilidad)
      - name: Run Snyk SCA (generate report)
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          snyk test --all-projects --json > snyk-report.json

      # Sube el reporte Snyk como Artifact (evidencia)
      - name: Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sca-report
          path: snyk-report.json
          if-no-files-found: ignore

  # ============================
  # JOB 3: DAST (APLICACIÓN)
  # ============================
  dast_zap:
    name: DAST (OWASP ZAP Baseline)
    needs: sca_snyk
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Ejecuta OWASP ZAP Baseline (spider + passive scan, sin ataque activo)
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        continue-on-error: true
        with:
          target: "http://testphp.vulnweb.com/"
          cmd_options: "-a"

      # Sube los reportes como artifacts para evidencia (HTML/MD/JSON)
      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_html.html
            report_md.md
            report_json.json
          if-no-files-found: ignore
